<!DOCTYPE html>
<html lang="<%= config.language || 'en' %>">
    <%- partial('_partial/configcss/font') %>
    <%- partial('_partial/head') %>
    <%- partial('_partial/configcss/width') %>
    <%- partial('_partial/configcss/color') %>
    <%- partial('_partial/configcss/imageShow') %>

    <body>
        <script src="/js/darkmode-js.min.js"></script>
        <% if(theme.tool.darkMode) { %>
        <script>
            const options = {
                bottom: '40px', // default: '32px'
                right: 'unset', // default: '32px'
                left: '42px', // default: 'unset'
                time: '0.3s', // default: '0.3s'
                mixColor: '#fff', // default: '#fff'
                backgroundColor: '<% if(theme.color.enable) { %> <%=theme.color.background %>  <% } else { %> #e4e4e4 <%}%>',  // default: '#fff'
                buttonColorDark: '#100f2c',  // default: '#100f2c'
                buttonColorLight: '#fff', // default: '#fff'
                saveInCookies: true, // default: true,
                label: 'üåì', // default: ''
                autoMatchOsTheme: true // default: true
            }
            const darkmode = new Darkmode(options);
            darkmode.showWidget();
        </script>
        <% } %>
        <% if(theme.tool.leftToc) { %>
            <% if(is_post() && (!('leftToc' in page) || page.leftToc == true)) { %>
                <div class="left-toc-container">
                    <nav id="toc" class="bs-docs-sidebar"></nav>
                </div>
            <% } %>
        <% } %>
        <div class="paper">

            <% var tags,tagsInside, categories, categoriesInside; %>

            <% if(path == "index.html") { %>
                <div class="shadow-drop-2-bottom index-main">
                    <%- partial('_partial/header') %>
                    <%- partial('index') %>
                    <% if(theme.index.list) { %>
                        <%- partial('list') %>
                    <% } %>
                    <%- partial('_partial/footer') %>
                </div>
            <% } else if(path == "list/index.html") { %>
                <div class="shadow-drop-2-top paper-main">
                     <%- partial('_partial/post-header') %>
                     <%- partial('list') %>
                     <%- partial('_partial/footer') %>
                </div>
            <% } else if(path == "404.html") { %>
                <div class="shadow-drop-2-top paper-main">
                    <%- partial('_partial/404-template') %>
                    <%- partial('_partial/footer') %>
                </div>
            <% } else if(path == "recent-updates/index.html") { %>
                <div class="shadow-drop-2-top paper-main">
                    <%- partial('_partial/post-header') %>
                    <%- partial('_partial/recent-updates') %>
                    <%- partial('_partial/footer') %>
               </div>
            <% } else { %>
                <div class="shadow-drop-2-bottom paper-main">
                    <%- partial('_partial/post-header') %>

                    <% if(tags = (path == "tags/index.html")) { %>
                            <%- partial('tags') %>
                    <% } %>
                    <% if(categories = (path == "categories/index.html")) { %>
                            <%- partial('categories') %>
                    <% } %>

                    <% if(tagsInside = (path.length > "tags/index.html".length && path.substring(0, 5) == "tags/")) { %>
                            <%- partial('_partial/tags-list') %>
                    <% } %>
                    <% if(categoriesInside = (path.length > "categories/index.html".length && path.substring(0, 11) == "categories/")) { %>
                        <%- partial('_partial/categories-list') %>
                    <% } %>

                    <!--ËØ¥ÊòéÊòØÊñáÁ´†postÈ°µÈù¢-->
                    <% if (!tags && !categories && !tagsInside && !categoriesInside) { %>
                        <%- partial('post') %>

                    <% } %>

                    <%- partial('_partial/footer') %>
                </div>
            <% } %>
            <% if(theme.tool.returnToTop) { %>
                <!-- ÂõûÂà∞È°∂ÈÉ®ÁöÑÊåâÈíÆ-->
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            <% } %>
            <% if(theme.tool.returnToLast) { %>
                <!-- ËøîÂõûÁöÑÊåâÈíÆ-->
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            <% } %>

            <!-- ÊµÆÂä®Èü≥‰πêÊí≠ÊîæÂô® -->
            <% if(is_post() && page.music_link) { %>
                <div id="floating-music-player" class="floating-music-player">
                    <div class="music-player-header">
                        <span class="music-icon">üéµ</span>
                        <span class="music-title">ËÉåÊôØÈü≥‰πê</span>
                        <span class="music-tip">ËøôÁØáÊñáÁ´†ÂíåËøô‰∏™Èü≥‰πêÂæàÈÖçÂì¶ÔΩû</span>
                        <button class="music-toggle-btn" onclick="toggleMusicPlayer()">‚àí</button>
                    </div>
                    <div class="music-player-content" id="music-content">
                        <% 
                            // Â§ÑÁêÜÁΩëÊòì‰∫ëÈü≥‰πêÈìæÊé•
                            var musicUrl = page.music_link;
                            if (musicUrl.includes('music.163.com/song?id=')) {
                                // ÊèêÂèñÊ≠åÊõ≤ID
                                var songId = musicUrl.match(/id=(\d+)/);
                                if (songId) {
                                    // ‰ΩøÁî®hexo-tag-aplayerÁîüÊàêÊí≠ÊîæÂô®
                                    var aplayerTag = '{% meting "' + songId[1] + '" "netease" "song" "mini:true" %}';
                                    // ËøôÈáåÈúÄË¶ÅÊ∏≤ÊüìhexoÊ†áÁ≠æÔºå‰ΩÜEJSÊ®°Êùø‰∏≠Êó†Ê≥ïÁõ¥Êé•‰ΩøÁî®hexoÊ†áÁ≠æ
                                    // ÊâÄ‰ª•Êàë‰ª¨ÈúÄË¶ÅÁî®ÂÖ∂‰ªñÊñπÂºè
                                }
                            }
                        %>
                        <div id="aplayer-container"></div>
                        <script>
                            // ‰ΩøÁî®APlayerÁõ¥Êé•ÂàõÂª∫Êí≠ÊîæÂô®
                            <% if (page.music_link && page.music_link.includes('music.163.com/song?id=')) { %>
                                var songId = '<%= page.music_link.match(/id=(\d+)/)[1] %>';
                                
                                // ÈÄöËøáÁΩëÊòì‰∫ëÈü≥‰πêAPIËé∑ÂèñÊ≠åÊõ≤‰ø°ÊÅØ
                                fetch('https://api.injahow.cn/meting/?server=netease&type=song&id=' + songId)
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data && data.length > 0) {
                                            var song = data[0];
                                            var ap = new APlayer({
                                                container: document.getElementById('aplayer-container'),
                                                mini: false,
                                                fixed: false,
                                                autoplay: false,
                                                theme: '#25f277',
                                                loop: 'all',
                                                order: 'list',
                                                preload: 'auto',
                                                volume: 0.7,
                                                mutex: true,
                                                lrcType: 0,
                                                listFolded: false,
                                                listMaxHeight: '200px',
                                                audio: [{
                                                    name: song.name || 'ËÉåÊôØÈü≥‰πê',
                                                    artist: song.artist || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂',
                                                    url: song.url || 'https://music.163.com/song/media/outer/url?id=' + songId + '.mp3',
                                                    cover: song.pic || 'https://p1.music.126.net/placeholder.jpg'
                                                }]
                                            });
                                        } else {
                                            // Â¶ÇÊûúAPIÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à
                                            var ap = new APlayer({
                                                container: document.getElementById('aplayer-container'),
                                                mini: false,
                                                fixed: false,
                                                autoplay: false,
                                                theme: '#25f277',
                                                loop: 'all',
                                                order: 'list',
                                                preload: 'auto',
                                                volume: 0.7,
                                                mutex: true,
                                                lrcType: 0,
                                                listFolded: false,
                                                listMaxHeight: '200px',
                                                audio: [{
                                                    name: 'ËÉåÊôØÈü≥‰πê',
                                                    artist: 'ÁΩëÊòì‰∫ëÈü≥‰πê',
                                                    url: 'https://music.163.com/song/media/outer/url?id=' + songId + '.mp3',
                                                    cover: 'https://p1.music.126.net/placeholder.jpg'
                                                }]
                                            });
                                        }
                                    })
                                    .catch(error => {
                                        console.log('Ëé∑ÂèñÈü≥‰πê‰ø°ÊÅØÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§‰ø°ÊÅØ');
                                        // APIÂ§±Ë¥•Êó∂ÁöÑÂ§áÁî®ÊñπÊ°à
                                        var ap = new APlayer({
                                            container: document.getElementById('aplayer-container'),
                                            mini: false,
                                            fixed: false,
                                            autoplay: false,
                                            theme: '#25f277',
                                            loop: 'all',
                                            order: 'list',
                                            preload: 'auto',
                                            volume: 0.7,
                                            mutex: true,
                                            lrcType: 0,
                                            listFolded: false,
                                            listMaxHeight: '200px',
                                            audio: [{
                                                name: 'ËÉåÊôØÈü≥‰πê',
                                                artist: 'ÁΩëÊòì‰∫ëÈü≥‰πê',
                                                url: 'https://music.163.com/song/media/outer/url?id=' + songId + '.mp3',
                                                cover: 'https://p1.music.126.net/placeholder.jpg'
                                            }]
                                        });
                                    });
                            <% } %>
                        </script>
                    </div>
                </div>
            <% } %>
    </body>
</html>
<script src="<%= url_for('/js/emojiHandler.js') %>"></script>                 
<script>
    document.addEventListener('DOMContentLoaded', () => {
        wrapEmojis('.paper');
        initFloatingMusicPlayer();
    });

    // ÊµÆÂä®Èü≥‰πêÊí≠ÊîæÂô®ÂäüËÉΩ
    function initFloatingMusicPlayer() {
        const player = document.getElementById('floating-music-player');
        if (!player) return;

        let isDragging = false;
        let startX, startY, startLeft, startTop;

        // ÊãñÂä®ÂäüËÉΩ
        player.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('music-toggle-btn')) return;
            
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(window.getComputedStyle(player).left) || 0;
            startTop = parseInt(window.getComputedStyle(player).top) || 0;
            
            player.style.cursor = 'grabbing';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            let newLeft = startLeft + deltaX;
            let newTop = startTop + deltaY;
            
            // ËæπÁïåÊ£ÄÊü•
            const rect = player.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            if (newLeft < 0) newLeft = 0;
            if (newLeft + rect.width > windowWidth) newLeft = windowWidth - rect.width;
            if (newTop < 0) newTop = 0;
            if (newTop + rect.height > windowHeight) newTop = windowHeight - rect.height;
            
            player.style.left = newLeft + 'px';
            player.style.top = newTop + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (!isDragging) return;
            
            isDragging = false;
            player.style.cursor = 'grab';
            
            // Ëá™Âä®Èù†Ëæπ
            autoSnapToEdge();
        });

        // Ëá™Âä®Èù†ËæπÂäüËÉΩ
        function autoSnapToEdge() {
            const rect = player.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // Âà§Êñ≠Ë∑ùÁ¶ªÂì™ËæπÊõ¥Ëøë
            const distanceToLeft = centerX;
            const distanceToRight = windowWidth - centerX;
            const distanceToTop = centerY;
            const distanceToBottom = windowHeight - centerY;
            
            const minDistance = Math.min(distanceToLeft, distanceToRight, distanceToTop, distanceToBottom);
            
            if (minDistance === distanceToLeft) {
                // Èù†Â∑¶
                player.style.left = '20px';
            } else if (minDistance === distanceToRight) {
                // Èù†Âè≥
                player.style.left = (windowWidth - rect.width - 20) + 'px';
            } else if (minDistance === distanceToTop) {
                // Èù†‰∏ä
                player.style.top = '20px';
            } else {
                // Èù†‰∏ã
                player.style.top = (windowHeight - rect.height - 20) + 'px';
            }
        }

        // Á™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂ÈáçÊñ∞ÂÆö‰Ωç
        window.addEventListener('resize', () => {
            autoSnapToEdge();
        });
    }

    // ÂàáÊç¢Êí≠ÊîæÂô®Â±ïÂºÄ/Êî∂Ëµ∑
    function toggleMusicPlayer() {
        const content = document.getElementById('music-content');
        const btn = document.querySelector('.music-toggle-btn');
        const player = document.getElementById('floating-music-player');
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            btn.textContent = '‚àí';
            player.style.height = 'auto';
        } else {
            content.style.display = 'none';
            btn.textContent = '+';
            player.style.height = '40px';
        }
    }
</script>
